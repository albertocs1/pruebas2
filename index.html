<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Partes de Obra 2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e40af">
<link rel="manifest" href="manifest.json">
<style>
/* ==== Estilos ==== */
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin:20px; background:#f4f6f8; color:#333; }
h1 { margin-bottom:5px; text-align:left; font-size:2em; }
#selectedCompanyName { text-align:left; font-size:1.7em; color:#1e40af; margin-bottom:15px; font-weight:600; }
#companyMenu, #calendarView { display:none; }
.company-item { display:inline-block; padding:10px 20px; margin:5px 5px 5px 0; cursor:pointer; border-radius:25px; background:#1e40af; color:white; font-weight:bold; transition:all 0.3s ease; white-space:nowrap; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.company-item:hover { background:#3749c1; transform:translateY(-2px); }
#monthHeader { display:grid; grid-template-columns:1fr auto 1fr; align-items:center; margin-bottom:15px; }
#monthHeader #calendarTitle { font-size:1.7em; font-weight:bold; text-align:center; }
#monthHeader button { padding:8px 16px; border-radius:6px; background:transparent; color:black; font-weight:bold; border:none; cursor:pointer; transition:0.2s; }
#monthHeader button:first-child { justify-self:start; }
#monthHeader button:last-child { justify-self:end; }
#monthHeader button:hover { background: rgba(0,0,0,0.05); transform:translateY(-1px); }
#calendar { display:grid; grid-template-columns:repeat(7,1fr); gap:8px; margin-top:10px; }
.day { background:white; border-radius:12px; min-height:100px; padding:8px; position:relative; box-shadow:0 2px 8px rgba(0,0,0,0.1); transition:0.2s; display:flex; flex-direction:column; }
.day:hover { transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,0.15); }
.day .worker-preview-container { margin-top:20px; overflow-y:auto; max-height:70px; }
.weekdays { display:grid; grid-template-columns:repeat(7,1fr); margin-bottom:5px; font-weight:bold; text-align:center; border-bottom:2px solid #ccc; }
.weekdays div { padding:6px 0; }
.weekend { background-color:#d0e7ff; border-radius:12px; }
.today { background-color:#1e3a8a; color:white; }
.add-btn { position:absolute; top:6px; right:6px; width:28px; height:28px; border-radius:50%; background:#4caf50; color:white; border:none; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.2); transition:0.2s; }
.add-btn:hover { background:#45a049; transform:translateY(-1px); }
.modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
.modal-content { background:white; padding:25px; border-radius:12px; width:500px; max-height:90%; overflow-y:auto; box-shadow:0 5px 15px rgba(0,0,0,0.3); }
.close { float:right; cursor:pointer; color:red; font-size:20px; }
label { display:block; margin-top:12px; }
input, select { width:100%; padding:6px; margin-top:5px; border-radius:6px; border:1px solid #ccc; }
.work-block { margin-top:12px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#f9f9f9; }
.remove-btn { background:#e53935; color:white; border:none; padding:4px 8px; margin-top:5px; cursor:pointer; border-radius:4px; }
.remove-btn:hover { background:#c62828; }
.add-work-btn { margin-top:12px; background:#2196f3; color:white; border:none; padding:8px 12px; cursor:pointer; border-radius:6px; }
.add-work-btn:hover { background:#1976d2; }
.back-btn { margin-bottom:15px; background:#666; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; }
.back-btn:hover { background:#444; }
#daySummary h3 { margin-top:0; }
#daySummary hr { margin:5px 0; }
#daySummary .totalHours { font-weight:normal; }
#costModal label { margin-top:8px; font-weight:bold; }
#costModal input { margin-bottom:6px; }
.summary-btn { margin-left:6px; padding:2px 6px; font-size:0.85em; cursor:pointer; border:none; border-radius:4px; }
.summary-btn.edit { background:#2196f3; color:white; }
.summary-btn.edit:hover { background:#1976d2; }
.summary-btn.delete { background:#e53935; color:white; }
.summary-btn.delete:hover { background:#c62828; }

/* ==== UX m√≥vil ==== */
@media (max-width: 768px) {
  h1 { font-size: 1.6em; }
  #selectedCompanyName { font-size: 1.3em; }

  /* Modal ocupa casi toda la pantalla */
  .modal-content {
    width: 90% !important;
    height: 90% !important;
    max-height: none !important;
    border-radius: 8px;
    padding: 15px;
  }

  /* Calendario: menos columnas */
  #calendar {
    grid-template-columns: repeat(2, 1fr) !important;
    gap: 12px;
  }

  .day {
    min-height: 80px;
    padding: 6px;
    font-size: 0.85em;
  }

  .day .worker-preview-container {
    max-height: 50px;
    font-size: 0.75em;
  }

  /* Bot√≥n + m√°s peque√±o y visible */
  .add-btn {
    width: 24px;
    height: 24px;
    font-size: 14px;
    top: 4px;
    right: 4px;
  }

  /* Header calendario compacto */
  #monthHeader {
    grid-template-columns: 1fr;
    text-align: center;
    gap: 8px;
  }
  #monthHeader button {
    font-size: 0.9em;
    padding: 6px 12px;
  }

  /* Semana (cabecera d√≠as) en scroll horizontal */
  .weekdays {
    display: flex;
    overflow-x: auto;
    font-size: 0.85em;
  }
  .weekdays div {
    min-width: 40px;
  }

  /* Formularios m√°s compactos */
  input, select {
    font-size: 0.9em;
    padding: 5px;
  }
}
</style>
</head>
<body>

<h1>Partes de Obra 2</h1>
<h2 id="selectedCompanyName"></h2>

<div id="companyMenu">
  <h2>Empresas</h2>
  <div id="companyList"></div>
  <input type="text" id="newCompanyName" placeholder="Nueva empresa">
  <button onclick="addCompany()">A√±adir Empresa</button>
</div>

<div id="calendarView">
  <button class="back-btn" onclick="backToMenu()">‚Üê Volver</button>
  <button id="exportBtn" type="button" class="back-btn">üì• Exportar a Excel</button>
  <div id="monthHeader">
    <button onclick="prevMonth()">¬´ Mes Anterior</button>
    <div id="calendarTitle"></div>
    <button onclick="nextMonth()">Mes Siguiente ¬ª</button>
  </div>
  <div class="weekdays">
    <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
  </div>
  <div id="calendar"></div>
</div>

<div id="calendarModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modalContentArea"></div>
  </div>
</div>

<div id="costModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCostModal()">&times;</span>
    <h2>Coste por Rango</h2>
    <div id="costInputs"></div>
    <button onclick="confirmCosts()">Confirmar</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
// ==== Firebase ====
const firebaseConfig = {
  apiKey: "AIzaSyBeF5tQ7lO6fjiOu1IeINTzWD0IJC6y1To",
  authDomain: "partes-c884f.firebaseapp.com",
  projectId: "partes-c884f",
  storageBucket: "partes-c884f.firebasestorage.app",
  messagingSenderId: "559876972118",
  appId: "1:559876972118:web:f456bc3af643aa3a1225f7"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==== Variables Globales ====
let companyData = {};
let currentCompany = null;
let currentDate = null;
let currentMonth = null;
let currentYear = null;
let costByRank = {};
let exportCallback = null;

// ==== Funciones Firebase ====
function saveToStorage(){ if(!currentCompany) return; db.ref('companies/'+currentCompany).set(companyData[currentCompany]); }
function loadFromStorage(callback){ db.ref('companies').once('value', snapshot=>{ companyData = snapshot.val() || {}; if(callback) callback(); }); }

// ==== UI y Calendario ====
function showMenu(){ loadFromStorage(renderCompanyList); document.getElementById('companyMenu').style.display='block'; document.getElementById('calendarView').style.display='none'; document.getElementById('selectedCompanyName').textContent=''; }
function addCompany(){ const name=document.getElementById('newCompanyName').value.trim(); if(!name || companyData[name]) return; companyData[name]={calendar:{},templates:[]}; document.getElementById('newCompanyName').value=''; saveToStorage(); renderCompanyList(); }
function renderCompanyList(){ const container=document.getElementById('companyList'); container.innerHTML=''; Object.keys(companyData).sort().forEach(c=>{ const div=document.createElement('div'); div.className='company-item'; div.textContent=c; div.onclick=()=>openCompany(c); container.appendChild(div); }); }
function openCompany(name){ currentCompany=name; const today=new Date(); currentMonth=today.getMonth(); currentYear=today.getFullYear(); document.getElementById('companyMenu').style.display='none'; document.getElementById('calendarView').style.display='block'; document.getElementById('selectedCompanyName').textContent=name; renderCalendar(); }
function backToMenu(){ currentCompany=null; showMenu(); }
function prevMonth(){ currentMonth--; if(currentMonth<0){ currentMonth=11; currentYear--; } renderCalendar(); }
function nextMonth(){ currentMonth++; if(currentMonth>11){ currentMonth=0; currentYear++; } renderCalendar(); }

function renderCalendar(){
  const calendarDiv=document.getElementById('calendar'); calendarDiv.innerHTML='';
  const monthNames=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  document.getElementById('calendarTitle').textContent=`${monthNames[currentMonth]} ${currentYear}`;
  const daysInMonth=new Date(currentYear,currentMonth+1,0).getDate();
  let firstDay=(new Date(currentYear,currentMonth,1).getDay()+6)%7;
  for(let i=0;i<firstDay;i++) calendarDiv.appendChild(document.createElement('div'));
  const today=new Date(); const todayStr=`${today.getFullYear()}-${today.getMonth()+1}-${today.getDate()}`;
  for(let day=1;day<=daysInMonth;day++){
    const dateObj=new Date(currentYear,currentMonth,day); const dateKey=`${currentYear}-${currentMonth+1}-${day}`;
    const div=document.createElement('div'); div.className='day';
    if((dateObj.getDay()+6)%7>=5) div.classList.add('weekend');
    if(dateKey===todayStr) div.classList.add('today');
    const dayNumber=document.createElement('div'); dayNumber.textContent=day; dayNumber.style.position='absolute'; dayNumber.style.top='6px'; dayNumber.style.left='6px'; dayNumber.style.fontWeight='bold'; div.appendChild(dayNumber);
    const btn=document.createElement('button'); btn.textContent='+'; btn.className='add-btn'; btn.onclick=(ev)=>{ ev.stopPropagation(); openModal(dateKey,false); }; div.appendChild(btn);
    const dayData=companyData[currentCompany].calendar[dateKey];
    if(dayData && dayData.length>0){
      const containerPreview=document.createElement('div'); containerPreview.className='worker-preview-container';
      dayData.forEach(w=>{ const p=document.createElement('div'); p.textContent=w.name+' ('+w.total+'h)'; p.style.fontSize='0.85em'; containerPreview.appendChild(p); });
      div.appendChild(containerPreview);
    }
    div.onclick=()=>{ if(companyData[currentCompany].calendar[dateKey]) showDaySummary(dateKey); };
    calendarDiv.appendChild(div);
  }
}

// ==== Modal trabajadores ====
function openModal(date, readonly=false, entry=null, entryIndex=null){
  currentDate = date;
  document.getElementById('calendarModal').style.display = 'flex';
  const modalContent = document.getElementById('modalContentArea');

  modalContent.innerHTML = `<span class="close" onclick="closeModal()">&times;</span>
    <h2>${entry ? 'Editar Trabajador' : 'Registrar Trabajadores'} - ${formatDate(date)}</h2>
    <div id="quickForm">
      <label>Trabajador frecuente:<select id="quickWorkerTemplate"></select></label>
      <label>Nombre trabajador:<input type="text" id="quickWorkerName"></label>
      <label>Rango:<input type="text" id="quickWorkerRank"></label>
      <div id="workEntries"></div>
      <button type="button" class="add-work-btn" onclick="addWorkEntry()">+ A√±adir trabajo</button>
      <label>Horas Totales:<input type="number" id="totalHours" readonly></label>
      <button onclick="saveEntry(${entryIndex !== null ? entryIndex : ''})">${entry ? 'Actualizar' : 'Guardar'}</button>
    </div>`;

  const quickTemplate = document.getElementById('quickWorkerTemplate');
  quickTemplate.innerHTML = '<option value=""></option>';
  companyData[currentCompany].templates.forEach(t => {
    const option = document.createElement('option');
    option.value = t.name;
    option.textContent = t.name + ' (' + t.rank + ')';
    quickTemplate.appendChild(option);
  });

  quickTemplate.onchange = () => {
    const t = companyData[currentCompany].templates.find(x => x.name === quickTemplate.value);
    if(t){
      document.getElementById('quickWorkerName').value = t.name;
      document.getElementById('quickWorkerRank').value = t.rank;
    }
  };

  document.getElementById('quickWorkerName').value = entry ? entry.name : '';
  document.getElementById('quickWorkerRank').value = entry ? entry.rank : '';
  document.getElementById('workEntries').innerHTML = '';

  if(entry){
    entry.works.forEach(w => addWorkEntry(w.work, w.hours));
  } else {
    addWorkEntry();
  }

  updateTotalHours();
}

function closeModal(){ document.getElementById('calendarModal').style.display='none'; }
function addWorkEntry(work='',hours=''){
  const container=document.getElementById('workEntries'); const div=document.createElement('div'); div.className='work-block';
  div.innerHTML=`<label>Trabajo realizado: <input type="text" class="workName" value="${work}" list="workSuggestions"><datalist id="workSuggestions"></datalist></label>
    <label>Horas: <input type="number" class="workHours" value="${hours}" min="0"></label>
    <button class="remove-btn" type="button">Eliminar</button>`;
  const datalist=div.querySelector('datalist'); const previousWorks=new Set();
  for(const day in companyData[currentCompany].calendar){ companyData[currentCompany].calendar[day].forEach(entry=>{ entry.works.forEach(w=>previousWorks.add(w.work)); }); }
  previousWorks.forEach(w=>{ const option=document.createElement('option'); option.value=w; datalist.appendChild(option); });
  div.querySelector('.remove-btn').onclick=()=>{ div.remove(); updateTotalHours(); };
  div.querySelector('.workHours').oninput=updateTotalHours;
  container.appendChild(div);
}
function updateTotalHours(){ let total=0; document.querySelectorAll('#workEntries .workHours').forEach(input=>{ total+=parseFloat(input.value)||0; }); document.getElementById('totalHours').value=total; }
function saveEntry(index=null){
  const name=document.getElementById('quickWorkerName').value.trim(); const rank=document.getElementById('quickWorkerRank').value.trim();
  if(!name||!rank){ alert('Completa nombre y rango.'); return; }
  const works=[]; document.querySelectorAll('#workEntries .work-block').forEach(div=>{ const work=div.querySelector('.workName').value.trim(); const hours=parseFloat(div.querySelector('.workHours').value)||0; if(work) works.push({work,hours}); });
  const total=works.reduce((s,w)=>s+w.hours,0); const entry={name,rank,works,total};
  if(!companyData[currentCompany].calendar[currentDate]) companyData[currentCompany].calendar[currentDate]=[];
  if(index!==null){ companyData[currentCompany].calendar[currentDate][index]=entry; } else { companyData[currentCompany].calendar[currentDate].push(entry); }
  if(!companyData[currentCompany].templates.some(t=>t.name===name)) companyData[currentCompany].templates.push({name,rank});
  saveToStorage(); closeModal(); renderCalendar(); showDaySummary(currentDate);
}

// ==== Resumen d√≠a ====
function showDaySummary(date){
  currentDate=date; const modal=document.getElementById('calendarModal'); modal.style.display='flex'; const modalContent=document.getElementById('modalContentArea');
  const entries=companyData[currentCompany].calendar[date]||[];
  let html=`<h2>Resumen del d√≠a - ${formatDate(date)}</h2>`;
  if(entries.length===0){ html+='<p>No hay registros.</p>'; }
  else{
    let totalHoras=0; let importeTotal=0;
    entries.forEach((entry,i)=>{ const importe=(entry.total*(costByRank[entry.rank]||0)); totalHoras+=entry.total; importeTotal+=importe;
      html+=`<div class="entry">
        <strong>${entry.name}</strong> (${entry.rank})<br>
        Trabajos: ${entry.works.map(w=>`${w.work} (${w.hours}h)`).join(', ')}<br>
        <span class="totalHours">Total: ${entry.total}h | Importe: ${importe.toFixed(2)}‚Ç¨</span>
        <button class="summary-btn edit" onclick="openModal('${date}',false,${JSON.stringify(entry)},${i})">Editar</button>
        <button class="summary-btn delete" onclick="deleteEntry('${date}',${i})">Eliminar</button>
      </div><hr>`; });
    html+=`<p><strong>Total Horas:</strong> ${totalHoras}h</p>`;
    html+=`<p><strong>Importe Total:</strong> ${importeTotal.toFixed(2)}‚Ç¨</p>`;
  }
  modalContent.innerHTML=html;
}
function deleteEntry(date,index){ if(confirm('¬øEliminar este registro?')){ companyData[currentCompany].calendar[date].splice(index,1); saveToStorage(); renderCalendar(); showDaySummary(date); } }
function closeCostModal(){ document.getElementById('costModal').style.display='none'; }
function formatDate(dateStr){ const [y,m,d]=dateStr.split('-'); return `${d}/${m}/${y}`; }

// ==== Exportaci√≥n Excel ====
document.getElementById('exportBtn').addEventListener('click',()=>{
  const costModal=document.getElementById('costModal'); const container=document.getElementById('costInputs');
  container.innerHTML='';
  const ranks=new Set();
  Object.values(companyData[currentCompany].calendar).forEach(entries=>entries.forEach(e=>ranks.add(e.rank)));
  ranks.forEach(rank=>{ container.innerHTML+=`<label>${rank}: <input type="number" id="cost_${rank}" placeholder="‚Ç¨/hora"></label>`; });
  exportCallback=exportToExcel;
  costModal.style.display='flex';
});
function confirmCosts(){ document.querySelectorAll('#costInputs input').forEach(input=>{ const rank=input.id.replace('cost_',''); costByRank[rank]=parseFloat(input.value)||0; }); closeCostModal(); if(exportCallback) exportCallback(); }

function exportToExcel(){
  const wb=XLSX.utils.book_new();
  const wsData=[['Fecha','Trabajador','Rango','Trabajo','Horas','Importe']];
  let resumenPorTrabajo={}; let resumenTotalHoras=0; let resumenTotalImporte=0;
  for(const date in companyData[currentCompany].calendar){
    companyData[currentCompany].calendar[date].forEach(entry=>{
      entry.works.forEach(w=>{
        const importe=w.hours*(costByRank[entry.rank]||0);
        wsData.push([date,entry.name,entry.rank,w.work,w.hours,importe.toFixed(2)]);
        if(!resumenPorTrabajo[w.work]) resumenPorTrabajo[w.work]={horas:0,importe:0};
        resumenPorTrabajo[w.work].horas+=w.hours; resumenPorTrabajo[w.work].importe+=importe;
        resumenTotalHoras+=w.hours; resumenTotalImporte+=importe;
      });
    });
  }
  const ws=XLSX.utils.aoa_to_sheet(wsData); XLSX.utils.book_append_sheet(wb,ws,'Partes de Obra');
  let resumenData=[['Trabajo','Horas Totales','Importe Total']];
  for(const work in resumenPorTrabajo){ resumenData.push([work,resumenPorTrabajo[work].horas,resumenPorTrabajo[work].importe.toFixed(2)]); }
  resumenData.push(['TOTAL',resumenTotalHoras,resumenTotalImporte.toFixed(2)]);
  const wsResumen=XLSX.utils.aoa_to_sheet(resumenData); XLSX.utils.book_append_sheet(wb,wsResumen,'Resumen Total por trabajo');
  XLSX.writeFile(wb,`${currentCompany}_partes.xlsx`);
}

// ==== Inicializaci√≥n ====
showMenu();
</script>
</body>
</html>

